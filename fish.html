<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>é±¼ç±»æ•°æ®å¯è§†åŒ–åˆ†æç³»ç»Ÿ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --alert-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --purple-color: #9b59b6;
            --teal-color: #1abc9c;
        }


        .chart-title {
            color: var(--dark-color);
            margin: 10px 0;
            font-size: 32px;
            font-weight: 600;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 18px;
            margin-bottom: 25px;
        }

        .axis line, .axis path {
            stroke: #666;
            stroke-width: 0.5;
        }

        .axis text {
            font-size: 12px;
            fill: #333;
        }

        .legend-item {
            cursor: pointer;
            margin: 0 10px 10px 0;
            display: inline-block;
            white-space: nowrap;
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .legend-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        #tooltip {
            position: absolute;
            padding: 15px;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #ddd;
            border-radius: 8px;
            pointer-events: none;
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 200px;
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        .axis-label {
            font-size: 14px;
            fill: #333;
            font-weight: 600;
        }

        circle {
            opacity: 0.8;
            transition: all 0.3s;
            stroke-width: 0;
        }

        circle:hover {
            stroke: #333;
            stroke-width: 2;
            opacity: 1;
            transform: scale(1.05);
        }

        .control-panel {
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .size-control {
            display: inline-block;
            margin: 0 8px;
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .size-control:hover {
            background-color: #f8f9fa;
        }

        .size-control.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        #statistics {
            margin: 40px auto;
            padding: 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        #stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        #stats-table th, #stats-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        #stats-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark-color);
        }

        #stats-table tr:hover {
            background-color: #f9fbfd;
        }

        svg {
            display: block;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .action-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-export {
            background: var(--secondary-color);
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }

        .btn-export:hover {
            background: #27ae60;
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-alert {
            background: var(--warning-color);
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3);
        }

        .btn-alert:hover {
            background: #d35400;
            box-shadow: 0 6px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-purple {
            background: var(--purple-color);
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.3);
        }

        .btn-purple:hover {
            background: #8e44ad;
            box-shadow: 0 6px 15px rgba(155, 89, 182, 0.4);
        }

        .btn-teal {
            background: var(--teal-color);
            box-shadow: 0 4px 10px rgba(26, 188, 156, 0.3);
        }

        .btn-teal:hover {
            background: #16a085;
            box-shadow: 0 6px 15px rgba(26, 188, 156, 0.4);
        }

        .alert-panel {
            background: #fff9e6;
            border: 1px solid var(--warning-color);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .alert-panel h3 {
            color: var(--warning-color);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item {
            padding: 10px;
            border-bottom: 1px solid #ffeeba;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .upload-container {
            text-align: center;
            padding: 30px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #fafafa;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .upload-container:hover {
            border-color: var(--primary-color);
            background: #f0f8ff;
        }

        .upload-container.drag-over {
            border-color: var(--secondary-color);
            background: #f0fff4;
        }

        .upload-icon {
            font-size: 48px;
            color: #bdc3c7;
            margin-bottom: 15px;
        }

        .threshold-control {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .threshold-item {
            margin: 10px 0;
        }

        .threshold-item label {
            display: inline-block;
            width: 200px;
            font-weight: 500;
        }

        .threshold-item input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .feature-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .stats-summary {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            min-width: 180px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 16px;
        }

        .footer {
            text-align: center;
            margin: 40px 0 20px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            font-size: 14px;
        }

        /* æ–°å¢æ•°æ®ç‚¹æ ·å¼ */
        .new-data-point {
            stroke: #000;
            stroke-width: 2px;
            filter: drop-shadow(0 0 3px rgba(255,255,0,0.8));
        }

        /* ä¸‹è½½é€‰é¡¹é¢æ¿ */
        .download-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .download-option {
            background: #f0f4f8;
            border: 1px solid #d1d8e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            width: 140px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .download-option:hover {
            background: #e3eaf3;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .download-icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .download-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .download-desc {
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="chart-title">é±¼ç±»æ•°æ®å¯è§†åŒ–åˆ†æ</h1>
        </div>

        <div class="action-bar">
            <button id="upload-btn" class="btn">
                <i class="upload-icon">ğŸ“</i> ä¸Šä¼ æ•°æ®
            </button>
            <button id="export-btn" class="btn btn-export">å¯¼å‡ºå®Œæ•´æ•°æ®</button>
            <button id="download-btn" class="btn btn-purple">ä¸‹è½½å›¾è¡¨/è¡¨æ ¼</button>
            <button id="check-alert-btn" class="btn btn-alert">æ£€æŸ¥å¼‚å¸¸</button>
        </div>

        <div class="download-options" id="download-options" style="display: none;">
            <div class="download-option" id="download-scatter">
                <span class="download-icon">ğŸ“Š</span>
                <div class="download-title">ä¸‹è½½æ•£ç‚¹å›¾</div>
                <div class="download-desc">JPGæ ¼å¼</div>
            </div>
            <div class="download-option" id="download-table">
                <span class="download-icon">ğŸ“‹</span>
                <div class="download-title">ä¸‹è½½ç»Ÿè®¡è¡¨æ ¼</div>
                <div class="download-desc">CSVæ ¼å¼</div>
            </div>
        </div>

        <div id="alert-area" class="alert-panel">
            <h3>âš ï¸ æ•°æ®å¼‚å¸¸è­¦å‘Š</h3>
            <div id="alert-content"></div>
        </div>

        <div class="upload-container" id="drop-area">
            <div class="upload-icon">ğŸ“¤</div>
            <h3>ä¸Šä¼ é±¼ç±»æ•°æ®CSVæ–‡ä»¶</h3>
            <p>æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ– <span style="color: var(--primary-color); font-weight: 500;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></p>
            <p style="font-size: 14px; color: #7f8c8d;">æ”¯æŒæ ¼å¼ï¼šCSV</p>
            <input type="file" id="file-input" accept=".csv" style="display: none;">
        </div>

        <div class="threshold-control">
            <h3>å¼‚å¸¸æ£€æµ‹é˜ˆå€¼è®¾ç½®</h3>
            <div class="threshold-item">
                <label for="weight-threshold">æœ€å¤§é‡é‡ (g):</label>
                <input type="number" id="weight-threshold" value="1500">
            </div>
            <div class="threshold-item">
                <label for="width-threshold">æœ€å¤§ä½“å®½ (cm):</label>
                <input type="number" id="width-threshold" value="15">
            </div>
            <div class="threshold-item">
                <label for="length-threshold">æœ€å¤§é•¿åº¦ (cm):</label>
                <input type="number" id="length-threshold" value="50">
            </div>
        </div>

        <div class="stats-summary">
            <div class="stat-card">
                <div class="stat-label">ç‰©ç§æ•°é‡</div>
                <div class="stat-value" id="species-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ•°æ®æ€»æ•°</div>
                <div class="stat-value" id="data-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡é‡é‡ (g)</div>
                <div class="stat-value" id="avg-weight">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡ä½“å®½ (cm)</div>
                <div class="stat-value" id="avg-width">0</div>
            </div>
        </div>

        <div class="control-panel">
            <h3>é€‰æ‹©å°ºå¯¸æŒ‡æ ‡</h3>
            <div class="size-control active" data-dim="length1">Length1</div>
            <div class="size-control" data-dim="length2">Length2</div>
            <div class="size-control" data-dim="length3">Length3</div>
        </div>

        <div id="legend" style="text-align: center; margin: 20px 0;"></div>

        <div id="tooltip"></div>
        <svg id="chart-svg" width="1280" height="680"></svg>

        <div id="statistics">
            <h2 class="chart-title" style="text-align: center;">ç»Ÿè®¡ä¿¡æ¯</h2>
            <table id="stats-table">
                <thead>
                    <tr>
                        <th>ç‰©ç§</th>
                        <th>æ•°é‡</th>
                        <th>å¹³å‡å®½åº¦ (cm)</th>
                        <th>å¹³å‡é‡é‡ (g)</th>
                        <th>å¹³å‡Length1(cm)</th>
                        <th>å¹³å‡Length2(cm)</th>
                        <th>å¹³å‡Length3(cm)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="footer">
            <p>é±¼ç±»æ•°æ®å¯è§†åŒ–åˆ†æ</p>
        </div>
    </div>

    <script>
        // æ–°å¢çŠ¶æ€å˜é‡
        let currentSizeDimension = 'length1';
        let hiddenSpecies = new Set(); // å­˜å‚¨è¢«éšè—çš„ç‰©ç§
        let processedData = []; // å­˜å‚¨å¤„ç†åçš„æ•°æ®
        let rawData = []; // å­˜å‚¨åŸå§‹æ•°æ®
        let uploadedData = []; // å­˜å‚¨ä¸Šä¼ çš„æ–°æ•°æ®
        let combinedData = []; // å­˜å‚¨åˆå¹¶åçš„æ•°æ®
        let color = null; // é¢œè‰²æ¯”ä¾‹å°º
        let svg = null; // SVGå…ƒç´ å¼•ç”¨
        let circles = null; // åœ†ç‚¹å…ƒç´ å¼•ç”¨
        let xScale, yScale; // æ¯”ä¾‹å°ºå¼•ç”¨
        let currentStatsData = []; // å­˜å‚¨å½“å‰ç»Ÿè®¡è¡¨æ ¼æ•°æ®

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('upload-btn').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', handleFileUpload);

            document.getElementById('export-btn').addEventListener('click', exportData);

            document.getElementById('download-btn').addEventListener('click', function() {
                const options = document.getElementById('download-options');
                options.style.display = options.style.display === 'flex' ? 'none' : 'flex';
            });

            document.getElementById('download-scatter').addEventListener('click', downloadChartAsJPG);
            document.getElementById('download-table').addEventListener('click', downloadTable);

            document.getElementById('check-alert-btn').addEventListener('click', checkDataAlerts);

            // è®¾ç½®æ‹–æ”¾åŒºåŸŸäº‹ä»¶
            const dropArea = document.getElementById('drop-area');
            dropArea.addEventListener('click', () => document.getElementById('file-input').click());

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('drag-over');
            }

            function unhighlight() {
                dropArea.classList.remove('drag-over');
            }

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            // åŠ è½½åˆå§‹æ•°æ®
            loadInitialData();
        });

        // åŠ è½½åˆå§‹æ•°æ®
        function loadInitialData() {
            // ä½¿ç”¨D3åŠ è½½åˆå§‹æ•°æ®
            d3.csv("Fish.csv", d3.autoType).then(data => {
                rawData = data;
                uploadedData = []; // é‡ç½®ä¸Šä¼ æ•°æ®
                combineData();
                updateSummaryStats();
            });
        }

        // åˆå¹¶åŸå§‹æ•°æ®å’Œä¸Šä¼ æ•°æ®
        function combineData() {
            // åˆå¹¶æ•°æ®å¹¶æ·»åŠ æ¥æºæ ‡è¯†
            combinedData = [
                ...rawData.map(d => ({...d, source: 'original'})),
                ...uploadedData.map(d => ({...d, source: 'uploaded'}))
            ];

            // å¤„ç†åˆå¹¶åçš„æ•°æ®
            processData(combinedData);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            handleFiles([file]);
        }

        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];
            if (file.type !== "text/csv" && !file.name.endsWith('.csv')) {
                alert('è¯·ä¸Šä¼ CSVæ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = d3.csvParse(e.target.result, d3.autoType);
                // ä¿å­˜ä¸Šä¼ çš„æ•°æ®
                uploadedData = csvData;
                combineData();
                updateSummaryStats();
                alert(`æˆåŠŸä¸Šä¼  ${csvData.length} æ¡æ•°æ®`);
            };
            reader.readAsText(file);
        }

        // å¤„ç†æ•°æ®
        function processData(data) {
            processedData = data.map(d => ({
                Species: d.Species,
                width: d['Width(cm)'],
                weight: d['Weight(g)'],
                length1: d['Length1(cm)'],
                length2: d['Length2(cm)'],
                length3: d['Length3(cm)'],
                height: d['Height(cm)'],
                source: d.source // ä¿ç•™æ¥æºä¿¡æ¯
            })).filter(d =>
                !isNaN(d.width) &&
                !isNaN(d.weight) &&
                d.width > 0 &&
                d.weight > 0
            );

            // æ›´æ–°ç»Ÿè®¡è¡¨æ ¼
            updateStatisticsTable();

            // æ¸²æŸ“å›¾è¡¨
            renderChart();
        }

        // æ›´æ–°ç»Ÿè®¡è¡¨æ ¼
        function updateStatisticsTable() {
            // æ–°å¢ç»Ÿè®¡æ•°æ®å¤„ç†
            const speciesGroups = d3.group(processedData, d => d.Species);
            currentStatsData = Array.from(speciesGroups, ([species, records]) => ({
                Species: species,
                Count: records.length,
                AvgWidth: d3.mean(records, d => d.width),
                AvgWeight: d3.mean(records, d => d.weight),
                AvgLength1: d3.mean(records, d => d.length1),
                AvgLength2: d3.mean(records, d => d.length2),
                AvgLength3: d3.mean(records, d => d.length3)
            }));

            // æ¸²æŸ“ç»Ÿè®¡è¡¨æ ¼
            const statsTable = d3.select("#stats-table tbody");
            statsTable.selectAll("tr")
                .data(currentStatsData)
                .join("tr")
                .html(d => `
                    <td>${d.Species}</td>
                    <td>${d.Count}</td>
                    <td>${d.AvgWidth.toFixed(2)}</td>
                    <td>${d.AvgWeight.toFixed(2)}</td>
                    <td>${d.AvgLength1.toFixed(2)}</td>
                    <td>${d.AvgLength2.toFixed(2)}</td>
                    <td>${d.AvgLength3.toFixed(2)}</td>
                `);
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart() {
            // æ¸…é™¤ç°æœ‰å›¾è¡¨
            d3.select("#chart-svg").selectAll("*").remove();

            if (processedData.length === 0) return;

            // è®¡ç®—ç‚¹çš„å¤§å°
            const sizeValues = processedData.map(d => d.length1);
            const sizeExtent = d3.extent(sizeValues);

            // è®¾ç½®æ¯”ä¾‹å°º
            const width = 1280, height = 680;
            const margin = { top: 40, right: 50, bottom: 60, left: 70 };

            // Xè½´æ”¹ä¸ºWidth
            xScale = d3.scaleLinear()
                .domain(d3.extent(processedData, d => d.width))
                .range([margin.left, width - margin.right])
                .nice();

            // Yè½´æ”¹ä¸ºWeight
            yScale = d3.scaleLinear()
                .domain(d3.extent(processedData, d => d.weight))
                .range([height - margin.bottom, margin.top])
                .nice();

            // æ”¹ä¸ºç»Ÿä¸€ä½¿ç”¨sizeScale
            // åŠ¨æ€è®¡ç®—åˆå§‹sizeæ¯”ä¾‹å°º
            const initialSizeValues = processedData.map(d => d[currentSizeDimension]);
            const size = d3.scaleSqrt()
                .domain(d3.extent(initialSizeValues))
                .range([3, 25]);

            color = d3.scaleOrdinal()
                .domain(Array.from(new Set(processedData.map(d => d.Species))))
                .range(d3.schemeTableau10);

            // åˆ›å»ºSVGç”»å¸ƒ
            svg = d3.select("#chart-svg")
                .attr("width", width)
                .attr("height", height);

            circles = svg.selectAll("circle")
                .data(processedData)
                .join("circle")
                .attr("cx", d => xScale(d.width))
                .attr("cy", d => yScale(d.weight))
                .attr("r", d => size(d[currentSizeDimension]))  // åŠ¨æ€å±æ€§
                .style("fill", d => color(d.Species))
                .style("opacity", d => hiddenSpecies.has(d.Species) ? 0 : 0.8) // åˆå§‹è®¾ç½®é€æ˜åº¦
                .classed("new-data-point", d => d.source === 'uploaded') // ä¸ºæ–°æ•°æ®ç‚¹æ·»åŠ ç‰¹æ®Šæ ·å¼
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            // ç»˜åˆ¶åæ ‡è½´
            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", width/2)
                .attr("y", 35)
                .style("text-anchor", "middle")
                .text("ä½“å®½ Width (cm)");  // ä¿®æ”¹Xè½´æ ‡ç­¾

            svg.append("g")
                .attr("class", "y-axis")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale))
                .append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("x", -height/2)
                .attr("y", -50)
                .style("text-anchor", "middle")
                .text("é‡é‡ Weight (g)");  // ä¿®æ”¹Yè½´æ ‡ç­¾

            // åˆ›å»ºå›¾ä¾‹ - ä¿®å¤ç‚¹ï¼šç¡®ä¿å›¾ä¾‹åˆå§‹çŠ¶æ€æ­£ç¡®
            const legend = d3.select("#legend")
                .selectAll(".legend-item")
                .data(color.domain())
                .join("div")
                .attr("class", d =>
                    `legend-item ${hiddenSpecies.has(d) ? '' : 'active'}`
                )
                .on("click", toggleVisibility);

            legend.html("")
                .each(function(d) {
                    const item = d3.select(this);
                    item.append("span")
                        .style("display", "inline-block")
                        .style("width", "14px")
                        .style("height", "14px")
                        .style("background-color", color(d))
                        .style("margin-right", "6px")
                        .style("border-radius", "3px");

                    item.append("span")
                        .text(d)
                        .style("font-size", "14px")
                        .style("color", "#444");
                });

            // æ·»åŠ å°ºå¯¸æ§åˆ¶äº‹ä»¶
            d3.selectAll(".size-control").on("click", function() {
                // åˆ‡æ¢activeçŠ¶æ€
                d3.selectAll(".size-control").classed("active", false);
                d3.select(this).classed("active", true);

                // æ›´æ–°å½“å‰å°ºå¯¸ç»´åº¦
                currentSizeDimension = d3.select(this).attr("data-dim");

                // è¿‡æ»¤å¯è§æ•°æ®ï¼ˆæ’é™¤éšè—ç‰©ç§ï¼‰
                const visibleData = processedData.filter(d => !hiddenSpecies.has(d.Species));

                // å¤„ç†ç©ºæ•°æ®é›†çš„æƒ…å†µ
                const safeExtent = (data) => data.length > 0 ? d3.extent(data) : [0, 1];

                // æ›´æ–°æ¯”ä¾‹å°ºdomainï¼ˆåŸºäºå¯è§æ•°æ®ï¼‰
                const newSizeValues = visibleData.map(d => d[currentSizeDimension]);
                size.domain(safeExtent(newSizeValues));

                // æ›´æ–°æ‰€æœ‰åœ†ç‚¹çš„åŠå¾„ï¼ˆåŒ…æ‹¬éšè—çš„ï¼Œä½†è§†è§‰ä¸Šä¸å¯è§ï¼‰
                circles.transition()
                    .duration(300)
                    .attr("r", d => size(d[currentSizeDimension]));
            });
        }

        // äº¤äº’åŠŸèƒ½
        function showTooltip(event, d) {
            // ä¿®å¤ç‚¹ï¼šå¦‚æœè¯¥ç‚¹è¢«éšè—ï¼Œåˆ™ä¸æ˜¾ç¤ºå·¥å…·æç¤º
            if (hiddenSpecies.has(d.Species)) {
                return;
            }

            d3.select(this)
                .style("opacity", 1)
                .style("stroke", "#333");

            d3.select("#tooltip")
                .html(`
                    <div style="margin-bottom:8px;font-weight:bold;color:${color(d.Species)};font-size:16px;">
                        ${d.Species} ${d.source === 'uploaded' ? '<span style="background:#ff0;color:#000;padding:2px 5px;border-radius:3px;font-size:12px;">æ–°æ•°æ®</span>' : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: auto auto; gap: 5px;">
                        <div>ä½“å®½:</div><div>${d.width.toFixed(2)} cm</div>
                        <div>é‡é‡:</div><div>${d.weight.toFixed(2)} g</div>
                        <div>Length1:</div><div>${d.length1.toFixed(2)} cm</div>
                        <div>Length2:</div><div>${d.length2.toFixed(2)} cm</div>
                        <div>Length3:</div><div>${d.length3.toFixed(2)} cm</div>
                        <div>æ¥æº:</div><div>${d.source === 'uploaded' ? 'ä¸Šä¼ æ•°æ®' : 'åŸå§‹æ•°æ®'}</div>
                    </div>
                `)
                .style("left", `${event.pageX + 15}px`)
                .style("top", `${event.pageY - 15}px`)
                .style("opacity", 1);
        }

        function hideTooltip() {
            // ä¿®å¤ç‚¹ï¼šå¦‚æœè¯¥ç‚¹è¢«éšè—ï¼Œåˆ™ä¸å¤„ç†
            if (hiddenSpecies.has(d3.select(this).datum().Species)) {
                return;
            }

            d3.select(this)
                .style("opacity", 0.8)
                .style("stroke", "none");
            d3.select("#tooltip").style("opacity", 0);
        }

        function toggleVisibility(event, s) {
            // ä¿®å¤ç‚¹ï¼šç›´æ¥æ ¹æ®å½“å‰éšè—çŠ¶æ€åˆ‡æ¢
            if (hiddenSpecies.has(s)) {
                hiddenSpecies.delete(s);
            } else {
                hiddenSpecies.add(s);
            }

            // æ›´æ–°å½“å‰å›¾ä¾‹é¡¹çš„çŠ¶æ€
            d3.select(this).classed("active", !hiddenSpecies.has(s));

            // è¿‡æ»¤å¯è§æ•°æ®
            const visibleData = processedData.filter(d => !hiddenSpecies.has(d.Species));

            // å®‰å…¨å¤„ç†ç©ºæ•°æ®é›†
            const safeExtent = (data, accessor) =>
                data.length > 0 ? d3.extent(data, accessor) : [0, 1];

            // æ›´æ–°åæ ‡è½´domain
            xScale.domain(safeExtent(visibleData, d => d.width)).nice();
            yScale.domain(safeExtent(visibleData, d => d.weight)).nice();

            // æ›´æ–°åæ ‡è½´æ˜¾ç¤ºï¼ˆå¸¦è¿‡æ¸¡åŠ¨ç”»ï¼‰
            svg.select(".x-axis")
                .transition()
                .duration(300)
                .call(d3.axisBottom(xScale).tickSizeOuter(0));

            svg.select(".y-axis")
                .transition()
                .duration(300)
                .call(d3.axisLeft(yScale).tickSizeOuter(0));

            // æ›´æ–°æ‰€æœ‰æ•°æ®ç‚¹çš„ä½ç½®å’Œé€æ˜åº¦
            circles.transition()
                .duration(300)
                .attr("cx", d => xScale(d.width))
                .attr("cy", d => yScale(d.weight))
                .style("opacity", d => hiddenSpecies.has(d.Species) ? 0 : 0.8);
        }

        // å¯¼å‡ºå®Œæ•´æ•°æ®
        function exportData() {
            if (combinedData.length === 0) {
                alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
                return;
            }

            // åˆ›å»ºCSVå†…å®¹
            const headers = ["Species", "Width(cm)", "Weight(g)", "Length1(cm)", "Length2(cm)", "Length3(cm)", "Height(cm)"];
            const csvContent = [
                headers.join(","),
                ...combinedData.map(d =>
                    [d.Species, d['Width(cm)'], d['Weight(g)'], d['Length1(cm)'],
                     d['Length2(cm)'], d['Length3(cm)'], d['Height(cm)']].join(",")
                )
            ].join("\n");

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "combined_fish_data.csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ä¸‹è½½ç»Ÿè®¡è¡¨æ ¼
        function downloadTable() {
            if (currentStatsData.length === 0) {
                alert("æ²¡æœ‰ç»Ÿè®¡æ•°æ®å¯ä¸‹è½½");
                return;
            }

            // åˆ›å»ºCSVå†…å®¹
            const headers = ["ç‰©ç§", "æ•°é‡", "å¹³å‡å®½åº¦(cm)", "å¹³å‡é‡é‡(g)", "å¹³å‡Length1(cm)", "å¹³å‡Length2(cm)", "å¹³å‡Length3(cm)"];
            const csvContent = [
                headers.join(","),
                ...currentStatsData.map(d => [
                    d.Species,
                    d.Count,
                    d.AvgWidth.toFixed(2),
                    d.AvgWeight.toFixed(2),
                    d.AvgLength1.toFixed(2),
                    d.AvgLength2.toFixed(2),
                    d.AvgLength3.toFixed(2)
                ].join(","))
            ].join("\n");

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "fish_statistics.csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // éšè—ä¸‹è½½é€‰é¡¹
            document.getElementById('download-options').style.display = 'none';
        }

        // ä¸‹è½½æ•£ç‚¹å›¾ä¸ºJPGæ ¼å¼
        function downloadChartAsJPG() {
            // åˆ›å»ºåŒ…å«å›¾è¡¨å’Œå›¾ä¾‹çš„å®¹å™¨
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.left = '-10000px';
            container.style.top = '0';
            container.style.width = '1300px';
            container.style.backgroundColor = 'white';
            container.style.padding = '20px';
            container.style.borderRadius = '10px';
            container.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';

            // å…‹éš†å›¾è¡¨åŒºåŸŸ
            const chartClone = document.getElementById('chart-svg').cloneNode(true);
            chartClone.style.display = 'block';
            chartClone.style.margin = '0 auto';

            // å…‹éš†å›¾ä¾‹
            const legendClone = document.getElementById('legend').cloneNode(true);
            legendClone.style.textAlign = 'center';
            legendClone.style.margin = '20px 0';

            // æ·»åŠ æ ‡é¢˜
            const title = document.createElement('h2');
            title.textContent = 'é±¼ç±»æ•°æ®å¯è§†åŒ–åˆ†æ';
            title.style.textAlign = 'center';
            title.style.color = '#2c3e50';
            title.style.marginBottom = '10px';

            // æ·»åŠ å‰¯æ ‡é¢˜
            const subtitle = document.createElement('div');
            subtitle.textContent = '';
            subtitle.style.textAlign = 'center';
            subtitle.style.color = '#7f8c8d';
            subtitle.style.marginBottom = '20px';

            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(title);
            container.appendChild(subtitle);
            container.appendChild(chartClone);
            container.appendChild(legendClone);

            document.body.appendChild(container);

            // ä½¿ç”¨html2canvasè½¬æ¢ä¸ºå›¾ç‰‡
            html2canvas(container, {
                scale: 2, // æé«˜åˆ†è¾¨ç‡
                backgroundColor: '#f5f7fa',
                useCORS: true
            }).then(canvas => {
                // è½¬æ¢ä¸ºJPG
                const imgData = canvas.toDataURL('image/jpeg', 0.95);

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = 'fish_visualization.jpg';
                link.href = imgData;
                link.click();

                // ç§»é™¤ä¸´æ—¶å®¹å™¨
                document.body.removeChild(container);

                // éšè—ä¸‹è½½é€‰é¡¹
                document.getElementById('download-options').style.display = 'none';
            });
        }

        // æ£€æŸ¥æ•°æ®å¼‚å¸¸
        function checkDataAlerts() {
            if (processedData.length === 0) {
                alert("æ²¡æœ‰æ•°æ®å¯åˆ†æ");
                return;
            }

            const weightThreshold = parseFloat(document.getElementById('weight-threshold').value) || 1500;
            const widthThreshold = parseFloat(document.getElementById('width-threshold').value) || 15;
            const lengthThreshold = parseFloat(document.getElementById('length-threshold').value) || 50;

            const alerts = [];

            // æ£€æŸ¥å¼‚å¸¸å€¼
            processedData.forEach(d => {
                if (d.weight > weightThreshold) {
                    alerts.push({
                        type: "weight",
                        value: d.weight,
                        threshold: weightThreshold,
                        species: d.Species,
                        message: `é‡é‡å¼‚å¸¸: ${d.Species} (${d.weight.toFixed(2)}g > ${weightThreshold}g)`
                    });
                }

                if (d.width > widthThreshold) {
                    alerts.push({
                        type: "width",
                        value: d.width,
                        threshold: widthThreshold,
                        species: d.Species,
                        message: `ä½“å®½å¼‚å¸¸: ${d.Species} (${d.width.toFixed(2)}cm > ${widthThreshold}cm)`
                    });
                }

                if (d.length1 > lengthThreshold || d.length2 > lengthThreshold || d.length3 > lengthThreshold) {
                    const maxLength = Math.max(d.length1, d.length2, d.length3);
                    alerts.push({
                        type: "length",
                        value: maxLength,
                        threshold: lengthThreshold,
                        species: d.Species,
                        message: `é•¿åº¦å¼‚å¸¸: ${d.Species} (é•¿åº¦å€¼ ${maxLength.toFixed(2)}cm > ${lengthThreshold}cm)`
                    });
                }
            });

            // æ›´æ–°æŠ¥è­¦æ˜¾ç¤º
            const alertArea = document.getElementById('alert-area');
            const alertContent = document.getElementById('alert-content');

            if (alerts.length === 0) {
                alertArea.style.display = 'none';
                alert("æœªæ£€æµ‹åˆ°æ•°æ®å¼‚å¸¸");
            } else {
                alertArea.style.display = 'block';
                alertContent.innerHTML = '';

                alerts.slice(0, 10).forEach(alert => {
                    const div = document.createElement('div');
                    div.className = 'alert-item';
                    div.innerHTML = `<strong>âš ï¸ ${alert.message}</strong>`;
                    alertContent.appendChild(div);
                });

                if (alerts.length > 10) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'alert-item';
                    moreDiv.innerHTML = `<em>... è¿˜æœ‰ ${alerts.length - 10} æ¡å¼‚å¸¸æœªæ˜¾ç¤º</em>`;
                    alertContent.appendChild(moreDiv);
                }
            }
        }

        // æ›´æ–°æ‘˜è¦ç»Ÿè®¡ä¿¡æ¯
        function updateSummaryStats() {
            if (processedData.length === 0) return;

            // è®¡ç®—ç‰©ç§æ•°é‡
            const speciesCount = new Set(processedData.map(d => d.Species)).size;
            document.getElementById('species-count').textContent = speciesCount;

            // æ•°æ®æ€»æ•°
            document.getElementById('data-count').textContent = processedData.length;

            // å¹³å‡é‡é‡
            const avgWeight = d3.mean(processedData, d => d.weight);
            document.getElementById('avg-weight').textContent = avgWeight ? avgWeight.toFixed(2) : '0';

            // å¹³å‡ä½“å®½
            const avgWidth = d3.mean(processedData, d => d.width);
            document.getElementById('avg-width').textContent = avgWidth ? avgWidth.toFixed(2) : '0';
        }
    </script>
</body>
</html>